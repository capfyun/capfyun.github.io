<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>JFinal 源码分析 [DB+ActiveRecord](转载)--云峰无聊博客</title>
  <meta name="keywords" content="无聊博客  无聊 博客" />
  <meta name="description" content="我很无聊，所以建了云峰小助手、无聊社区...." />
  <script src="./jquery-1.11.3.js" type="text/javascript"></script>
  <link href="./blog.css" rel="stylesheet">
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
<!--[if lt IE 9]>
<script src="./modernizr.js"></script>
<![endif]-->
</head>
<body>
<div class="ibody">
  <header>
    <h1>云峰无聊博客</h1>
    <h2>我很无聊，所以建了云峰小助手、无聊社区.....</h2>
    <div class="logo"><a href="./index.html"></a></div>
    <nav id="topnav"><a href="./index.html">首页</a>
    	<a href="./wdfx.html"  id="topnav_current"  >我的分享</a>
    	<a href="./sxxj.html"  >随心小记</a>
    <a href="./about.html">关于云峰</a></nav>
  </header>
  <article>
    <h2 class="about_h">您现在的位置是：<a href="./">首页</a>><a href="./wdfx.html">
				我的分享</a>> <a href="./article16.html">JFinal 源码分析 [DB+ActiveRecord](转载)</a></h2>
    <div class="index_about">
      <h2 class="c_titile">JFinal 源码分析 [DB+ActiveRecord](转载)</h2>
      <p class="box_c"><span class="d_time">发布时间：2015-11-06 18:50:00</span><span>作者：capfyun</span></p>
      <ul class="infos">
        <p><div class="article_body" id="nei" style="padding: 20px 5px 25px; margin-bottom: 0px; overflow-x: hidden; word-wrap: break-word; word-break: break-word; min-height: 340px; font-size: 16px; line-height: 1.7em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;"><div style="line-height: 1.7em;"><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我记得以前有人跟我说，“面试的时候要看spring的源码，要看ioc、aop的源码&quot;那为什么要看这些开源框架的源码呢，其实很多人都是&quot;应急式&quot;的去读，就像读一篇文章一下，用最快的速度把文章从头到尾读一遍，那结果就是当你读完它，你也不清楚它讲了一个什么故事，想表达什么。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">一个优秀的架构的源码我认为就好像一本名著一样，你的“文学”水平越高，你就越能读出作者设计的精妙之处。一篇源码在你不同水平的时候，能读出不同的东西，因此，我觉得优秀的框架的源码是经久不衰的，反复读多少次都不嫌多，直到你能设计出预期并驾齐驱甚至超越它的优美的架构。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">读源码起初是一件很痛苦的事儿，想赶紧把它像流水账一样的读完；慢慢实力增强后，会感觉到读源码能够不费力气的读通；再假以时日，就能看出这些精妙的设计模式的组合。我有一个朋友，典型的源码痴狂症，他跟我说他第一次看见spring的源码，感觉特别兴奋，读了一宿没睡觉.......好吧，我还有很长的路需要走~</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">话说多了，我们赶紧入正题：</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">JFinal的框架我24号的一篇博文写到过，它优秀的地方在精简代码上，那么有两处源码是我觉得是值得我们要好好解析一下，一处是初始化加载—servlet跳转，另一处是DB+ActiveRecord的映射。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么DB映射相对比较简单，我们这次就先来看看。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">首先我们看看代码，还是之前我写过的 dog与cat的故事。</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 采用DB+ActiveRecord模式  </span></span><span style="color: rgb(0, 128, 0);"></span>
ActiveRecordPlugin arp = <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> ActiveRecordPlugin(c3p0Plugin);  
me.add(arp);  
</span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 进行DB映射  </span></span><span style="color: rgb(0, 128, 0);"></span>
arp.addMapping(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">animal</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>, AnimalModel.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span>);</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第一步：为ActiveRecordPlugin的 private IDataSourceProvider dataSourceProvider 赋值。&nbsp;这三行代码就是加载DB映射的关键，那么我们复习一下，JFinal的DB映射无需配置文件，无需与DB对应的POJO，只需要写一个类，继承Model<m extends="" model="">即可。</m></p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么我们先来看看ActiveRecordPlugin的构造器。</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span><span style="color: rgb(0, 0, 0);"> ActiveRecordPlugin(IDataSourceProvider dataSourceProvider) {  
    </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span><span style="color: rgb(0, 0, 0);">(DbKit.MAIN_CONFIG_NAME, dataSourceProvider);  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这里重要的是dataSourceProvider，IDataSourceProvider是一个接口，它的运行时类型是</p><pre class="prettyprint css" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span class="tag" style="color: rgb(0, 0, 128);">JFinal</span> 源码分析 <span class="attr_selector">[DB+ActiveRecord]</span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么，可以看到</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>(DbKit.MAIN_CONFIG_NAME, dataSourceProvider);</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这段代码又继续读取另一个重载的构造器，然后调用了</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> ActiveRecordPlugin(String configName, IDataSourceProvider dataSourceProvider, <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">int</span></span><span style="color: rgb(0, 0, 0);"> transactionLevel) {  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (StrKit.isBlank(configName))  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">configName can not be blank</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (dataSourceProvider == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">dataSourceProvider can not be null</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.configName =<span style="color: rgb(0, 0, 0);"> configName.trim();  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.dataSourceProvider =<span style="color: rgb(0, 0, 0);"> dataSourceProvider;  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span><span style="color: rgb(0, 0, 0);">.setTransactionLevel(transactionLevel);  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">最重要的就是这行代码： this.dataSourceProvider = dataSourceProvider;</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这时，ActiveRecordPlugin的static变量的dataSourceProvider就已经被赋为C3p0Plugin的实例了。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第二步：定义映射用POJO</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span style="color: rgb(0, 0, 255);"><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"><span class="keyword" style="color: rgb(51, 51, 51);">class</span></span></span><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"> <span class="title">AnimalModel</span> <span class="keyword" style="color: rgb(51, 51, 51);">extends</span> <span class="title">Model</span>&lt;<span class="title">AnimalModel</span>&gt; {</span>...}</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这里Model的源码我们一会再看，现在不着急。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">然后进行映射</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 进行DB映射  </span></span><span style="color: rgb(0, 128, 0);"></span>
arp.addMapping(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">animal</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>, AnimalModel.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span>);</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这里我们又回到了ActiveRecordPlugin类里，它实际上有两个addMapping方法，只是参数不同。</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);">public</span> ActiveRecordPlugin addMapping(String tableName, String primaryKey, Class<span class="pi" style="color: rgb(153, 153, 153); font-weight: bold;">&lt;? extends Model&lt;?&gt;</span>&gt;<span style="color: rgb(0, 0, 0);"> modelClass) {  
<span class="indent">  </span>tableList.add(</span><span style="color: rgb(0, 0, 255);">new</span><span style="color: rgb(0, 0, 0);"> Table(tableName, primaryKey, modelClass));  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);">return</span> <span style="color: rgb(0, 0, 255);">this</span><span style="color: rgb(0, 0, 0);">;  
}  
  
</span><span style="color: rgb(0, 0, 255);">public</span> ActiveRecordPlugin addMapping(String tableName, Class<span class="pi" style="color: rgb(153, 153, 153); font-weight: bold;">&lt;? extends Model&lt;?&gt;</span>&gt;<span style="color: rgb(0, 0, 0);"> modelClass) {  
<span class="indent">  </span>tableList.add(</span><span style="color: rgb(0, 0, 255);">new</span><span style="color: rgb(0, 0, 0);"> Table(tableName, modelClass));  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);">return</span> <span style="color: rgb(0, 0, 255);">this</span><span style="color: rgb(0, 0, 0);">;  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我们看到，第一个方法多了一个参数 String primaryKey，我的代码里用的是第二个方法。这两个方法实际上都调用了tableList.add（Table tbl）方法，我们看看tableList是什么</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);">private</span> List<span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">Table</span>&gt;</span> tableList = <span style="color: rgb(0, 0, 255);">new</span> ArrayList<span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">Table</span>&gt;</span>();</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">它是ActiveRecordPlugin的一个成员变量，并且是private的，那我们可以猜到，tableList保存了所有的映射关系。（ActiveRecordPlugin真是强大，后面会越来越强大~）。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第三步：创建映射关系</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> Table(tableName, primaryKey, modelClass)  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> Table(tableName, modelClass)</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我们进去看看</p><pre class="prettyprint php" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> Table(String name, Class&lt;? extends Model&lt;<span class="preprocessor" style="color: rgb(153, 153, 153); font-weight: bold;">?&gt;</span>&gt;<span style="color: rgb(0, 0, 0);"> modelClass) {  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (StrKit.isBlank(name))  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Table name can not be blank.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (modelClass == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Model class can not be null.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.name =<span style="color: rgb(0, 0, 0);"> name.trim();  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.modelClass =<span style="color: rgb(0, 0, 0);"> modelClass;  
<span class="indent">  </span>}  
<span class="indent">  </span>  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> Table(String name, String primaryKey, Class&lt;? extends Model&lt;<span class="preprocessor" style="color: rgb(153, 153, 153); font-weight: bold;">?&gt;</span>&gt;<span style="color: rgb(0, 0, 0);"> modelClass) {  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (StrKit.isBlank(name))  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Table name can not be blank.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (StrKit.isBlank(primaryKey))  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Primary key can not be blank.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (modelClass == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Model class can not be null.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.name =<span style="color: rgb(0, 0, 0);"> name.trim();  
<span class="indent">  </span><span class="indent">  </span>setPrimaryKey(primaryKey.trim());   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> this.primaryKey = primaryKey.trim();  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.modelClass =<span style="color: rgb(0, 0, 0);"> modelClass;  
<span class="indent">  </span>}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这两个方法都是为Table里的成员变量赋值，第二个方法，也就是带primaryKey参数的那个多出一行，我们看看这一行干了什么</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">setPrimaryKey(primaryKey.trim());   <span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> this.primaryKey = primaryKey.trim(); </span></span><span style="color: rgb(0, 128, 0);"></span></pre><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> setPrimaryKey(String primaryKey) {  
String[] keyArr </span>= primaryKey.split(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">,</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (keyArr.length &gt; <span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">1</span></span><span style="color: rgb(0, 0, 0);">) {  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (StrKit.isBlank(keyArr[<span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">0</span></span>]) || StrKit.isBlank(keyArr[<span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">1</span></span><span style="color: rgb(0, 0, 0);">]))  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> IllegalArgumentException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">The composite primary key can not be blank.</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.primaryKey = keyArr[<span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">0</span></span><span style="color: rgb(0, 0, 0);">].trim();  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.secondaryKey = keyArr[<span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">1</span></span><span style="color: rgb(0, 0, 0);">].trim();  
}  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.primaryKey =<span style="color: rgb(0, 0, 0);"> primaryKey;  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这样的作用就是为Table下的primaryKey 和 secondaryKey赋值。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第四步：加载ActiveRecordPlugin</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么代码好像跟到这里就完事了，怎么回事？是不是跟丢了？</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">别忘了，ActiveRecordPlugin是在FinalConfig里的configPlugin方法加载的。那么又有谁来加载FinalConfig呢？</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">PS：（FinalConfig是我自己定义的类）</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这儿涉及到初始化的加载了，我简单的讲一下。</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span style="color: rgb(0, 0, 255);"><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"><span class="keyword" style="color: rgb(51, 51, 51);">class</span></span></span><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"> <span class="title">FinalConfig</span> <span class="keyword" style="color: rgb(51, 51, 51);">extends</span> <span class="title">JFinalConfig</span></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">整个JFinal的入口是web.xml的一段配置：</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">web-app</span>&gt;</span>  
  <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">filter</span>&gt;</span>  
    <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">filter-name</span>&gt;</span>jfinal<span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">filter-name</span>&gt;</span>  
    <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">filter-<span style="color: rgb(0, 0, 255);">class</span></span><span style="color: rgb(0, 0, 255);"></span>&gt;</span>com.jfinal.core.JFinalFilter<span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">filter-<span style="color: rgb(0, 0, 255);">class</span></span><span style="color: rgb(0, 0, 255);"></span>&gt;</span>  
    <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">init-param</span>&gt;</span>  
        <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">param-name</span>&gt;</span>configClass<span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">param-name</span>&gt;</span>  
        <span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">param-value</span>&gt;</span>com.demo.config.FinalConfig<span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">param-value</span>&gt;</span>  
    <span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">init-param</span>&gt;</span>  
<span class="tag" style="color: rgb(0, 0, 128);">&lt;/<span class="title">filter</span>&gt;</span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">接着我们看到了关键的累 JFinalFilter，还是点进去看看。</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span class="keyword" style="font-weight: bold;">final</span> <span style="color: rgb(0, 0, 255);"><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"><span class="keyword" style="color: rgb(51, 51, 51);">class</span></span></span><span class="class" style="color: rgb(68, 85, 136); font-weight: bold;"> <span class="title">JFinalFilter</span> <span class="keyword" style="color: rgb(51, 51, 51);">implements</span> <span class="title">Filter</span></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这个类实现了Filter接口，那就得实现方法init(),doFilter(),destroy()方法。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我们去看init()方法：</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> init(FilterConfig filterConfig) <span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throws</span> ServletException {  
<span class="indent">  </span>createJFinalConfig(filterConfig.getInitParameter(</span><span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">configClass</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">));  
<span class="indent">  </span>  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (jfinal.init(jfinalConfig, filterConfig.getServletContext()) == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">false</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> RuntimeException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">JFinal init error!</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span>  
<span class="indent">  </span>handler </span>=<span style="color: rgb(0, 0, 0);"> jfinal.getHandler();  
<span class="indent">  </span>constants </span>=<span style="color: rgb(0, 0, 0);"> Config.getConstants();  
<span class="indent">  </span>encoding </span>=<span style="color: rgb(0, 0, 0);"> constants.getEncoding();  
<span class="indent">  </span>jfinalConfig.afterJFinalStart();  
<span class="indent">  </span>  
<span class="indent">  </span>String contextPath </span>=<span style="color: rgb(0, 0, 0);"> filterConfig.getServletContext().getContextPath();  
<span class="indent">  </span>contextPathLength </span>= (contextPath == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span> || <span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">/</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>.equals(contextPath) ? <span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">0</span></span><span style="color: rgb(0, 0, 0);"> : contextPath.length());  
} </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">绕过其他的加载，直接看这行</p><pre class="prettyprint bash" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (jfinal.init(jfinalConfig, filterConfig.getServletContext()) == <span style="color: rgb(0, 0, 255);">false</span>)</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我们看看jfinal的类型是 private static final JFinal jfinal = JFinal.me();</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么我们去JFinal类里看看它的init方法。</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 0);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">boolean</span> init(JFinalConfig jfinalConfig, ServletContext servletContext) {  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.servletContext =<span style="color: rgb(0, 0, 0);"> servletContext;  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">this</span></span>.contextPath =<span style="color: rgb(0, 0, 0);"> servletContext.getContextPath();  
  
initPathUtil();  
  
Config.configJFinal(jfinalConfig);  </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> start plugin and init logger factory in this method  </span></span><span style="color: rgb(0, 128, 0);"></span>
constants =<span style="color: rgb(0, 0, 0);"> Config.getConstants();  
  
initActionMapping();  
initHandler();  
initRender();  
initOreillyCos();  
initI18n();  
initTokenManager();  
  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">true</span></span>;</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">看这行，下面这行主要是通过Config来加载暴露给程序员的核心文件，JFinalConfig的子类FinalConfig。</p><pre class="prettyprint sql" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">Config.configJFinal(jfinalConfig);  <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> <span class="operator"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">start</span> plugin <span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">and</span> init logger factory <span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">in</span> this method</span></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">再点进去</p><pre class="prettyprint sql" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">*<span style="color: rgb(0, 0, 0);"> Config order: constant, route, plugin, interceptor, <span class="operator"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">handler</span> 
</span></span><span class="operator">*/<span style="color: rgb(0, 0, 0);">  
tatic </span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);"> configJFinal(JFinalConfig jfinalConfig) {  
jfinalConfig.configConstant(constants);</span></span><span style="color: rgb(0, 0, 0);">             initLoggerFactory();  
jfinalConfig.configRoute(routes);  
jfinalConfig.configPlugin(plugins);                 startPlugins(); </span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> very important!!!  </span>
<span style="color: rgb(0, 0, 0);">jfinalConfig.configInterceptor(interceptors);  
jfinalConfig.config<span class="operator"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">Handler</span>(handlers);</span>  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这段代码实际上有个地方特别坑！就是</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">jfinalConfig.configPlugin(plugins);                 startPlugins(); <span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> very important!!!  </span></span><span style="color: rgb(0, 128, 0);"></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这行代码一共做了两件事，第一件事是jfinalConfig.configPlugin(plugins);来加载插件。还记得我们之前写的FinalConfig里的configPlugin(Plugins me) 方法吗？</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 128, 0);"><span class="javadoc" style="color: rgb(153, 153, 136); font-style: italic;">/*</span></span><span class="javadoc" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);">* 
 * Config plugin 
 * 配置插件 
 * JFinal有自己独创的 DB + ActiveRecord模式 
 * 此处需要导入ActiveRecord插件 
 </span><span style="color: rgb(0, 128, 0);">*/</span></span><span style="color: rgb(0, 128, 0);"></span><span style="color: rgb(0, 0, 0);">  
<span class="annotation">@Override</span>  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> configPlugin(Plugins me) {  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 读取db配置文件  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>loadPropertyFile(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">db.properties</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 采用c3p0数据源  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>C3p0Plugin c3p0Plugin = <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> C3p0Plugin(getProperty(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">jdbcUrl</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>),getProperty(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">user</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>), getProperty(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">password</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">));  
<span class="indent">  </span>me.add(c3p0Plugin);  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 采用DB+ActiveRecord模式  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>ActiveRecordPlugin arp = <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> ActiveRecordPlugin(c3p0Plugin);  
<span class="indent">  </span>me.add(arp);  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 进行DB映射  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>arp.addMapping(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">animal</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span>, AnimalModel.<span style="color: rgb(0, 0, 255);">class</span><span style="color: rgb(0, 0, 0);">);  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">它实际上就是通过me.add来加载插件，通过Config的 private static final Plugins plugins = new Plugins(); 来装载。第二件事就是 发现没有，后面的startPlugins()不是注释！是一个方法，这块实在太坑了，恰巧，这就是我们要找到的地方。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这个方法的代码有点长，但因为很重要，我不得不都贴出来。</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">private</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">static</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> startPlugins() {  
<span class="indent">  </span><span class="indent">  </span>List</span><iplugin> pluginList =<span style="color: rgb(0, 0, 0);"> plugins.getPluginList();  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (pluginList != <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">for</span></span><span style="color: rgb(0, 0, 0);"> (IPlugin plugin : pluginList) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">try</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> process ActiveRecordPlugin devMode  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (plugin <span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">instanceof</span> com.jfinal.plugin.activerecord.ActiveRecordPlugin) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>com.jfinal.plugin.activerecord.ActiveRecordPlugin arp </span>=<span style="color: rgb(0, 0, 0);">
 (com.jfinal.plugin.activerecord.ActiveRecordPlugin)plugin;  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (arp.getDevMode() == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>arp.setDevMode(constants.getDevMode());  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">boolean</span> success </span>=<span style="color: rgb(0, 0, 0);"> plugin.start();  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (!<span style="color: rgb(0, 0, 0);">success) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>String message </span>= <span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Plugin start error: </span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span> +<span style="color: rgb(0, 0, 0);"> plugin.getClass().getName();  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>log.error(message);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> RuntimeException(message);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">catch</span></span><span style="color: rgb(0, 0, 0);"> (Exception e) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>String message </span>= 
<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Plugin start error: </span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span> + plugin.getClass().getName() + <span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">. \n</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span> +<span style="color: rgb(0, 0, 0);"> e.getMessage();  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>log.error(message, e);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> RuntimeException(message, e);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span>}  </span></iplugin></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">上面这个方法一共有两个地方要注意一下，</p><pre class="prettyprint bash" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">for</span></span> (IPlugin plugin : pluginList) {</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">上面这行是循环所有的插件，并且启动插件的start(）方法。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么，我们中有一个插件记不记得是ActiveRecordPlugin的实例？那么</p><pre class="prettyprint sql" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">boolean success = plugin.<span class="operator"><span class="keyword" style="font-weight: bold;">start</span>();</span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这行代码就会执行ActiveRecordPlugin下的start()代码。终于绕回来了！！红军二万五千里长征，为了证明这个调用，我写了多少字....</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么我们看ActiveRecordPlugin下的start()方法吧，实际上这个start()方法是因为实现了IPlugin接口里的start()方法。</p><pre class="prettyprint php" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span><span style="color: rgb(0, 0, 0);"> boolean start() {  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (isStarted)  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">true</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span>  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (dataSourceProvider != <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span>dataSource </span>=<span style="color: rgb(0, 0, 0);"> dataSourceProvider.getDataSource();  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (dataSource == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> RuntimeException(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">ActiveRecord start error: </span>
ActiveRecordPlugin need DataSource or DataSourceProvider<span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(128, 0, 0);">);  </span>
<span class="indent">  </span>  
<span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (config == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span>config </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> Config(configName, dataSource, dialect, 
showSql, devMode, transactionLevel, containerFactory, cache);  
<span class="indent">  </span>DbKit.addConfig(config);  
<span class="indent">  </span>  
<span class="indent">  </span>boolean succeed </span>=<span style="color: rgb(0, 0, 0);"> TableBuilder.build(tableList, config);  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (succeed) {  
<span class="indent">  </span><span class="indent">  </span>Db.init();  
<span class="indent">  </span><span class="indent">  </span>isStarted </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">true</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span>}  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span><span style="color: rgb(0, 0, 0);"> succeed;  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">我们直接看与DB映射有关的代码，首先是取得dataSource，dataSourceProvider这个忘了没，忘了就翻到最前面，第一步讲的。</p><pre class="prettyprint ini" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span class="setting">config = <span style="color: rgb(0, 0, 255);"><span class="value">new</span></span><span class="value"> Config(configName, dataSource, dialect, showSql, devMode, transactionLevel, containerFactory, cache);</span></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这行代码中的dataSource 在插件里配置的C3P0数据源。这里的Config与前面加载FinalConfig的可不是一个啊，千万别看错了，这个是DB的 com.jfinal.plugin.activerecord.Config。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第五步：TableBuilder</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">来自ActiveRecordPlugin.java</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span class="keyword" style="font-weight: bold;">boolean</span> succeed = TableBuilder.build(tableList, config);</pre><pre class="prettyprint php" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">static</span></span> boolean build(<span class="keyword" style="font-weight: bold;">List</span><span style="color: rgb(0, 0, 0);"> tableList, Config config) {  
<span class="indent">  </span><span class="indent">  </span>Table temp </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span><span class="indent">  </span>Connection conn </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">try</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>conn </span>=<span style="color: rgb(0, 0, 0);"> config.dataSource.getConnection();  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>TableMapping tableMapping </span>=<span style="color: rgb(0, 0, 0);"> TableMapping.me();  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">for</span></span><span style="color: rgb(0, 0, 0);"> (Table table : tableList) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>temp </span>=<span style="color: rgb(0, 0, 0);"> table;  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>doBuild(table, conn, config);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>tableMapping.putTable(table);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>DbKit.addModelToConfigMapping(table.getModelClass(), config);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">true</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span><span class="indent">  </span>} </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">catch</span></span><span style="color: rgb(0, 0, 0);"> (<span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">Exception</span> e) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (temp != <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>System.err.println(</span><span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">Can not create Table object, </span>
maybe the table <span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(128, 0, 0);"> + temp.getName() + </span><span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"> <span style="color: rgb(0, 0, 255);">is</span> not exists.<span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(128, 0, 0);">);  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> ActiveRecordException(e);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);">finally</span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>config.close(conn);  
<span class="indent">  </span><span class="indent">  </span>}  
   }  </span><table> 
 </table></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这里循环所有的tableList，对每个Table对象进行建表。那么我们先看看Table是用什么来存储数据库映射关系的，相信大家都能猜到是Map了。</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">class</span><span style="color: rgb(0, 0, 0);"> Table {  
<span class="indent">  </span>
    </span><span style="color: rgb(0, 0, 255);">private</span><span style="color: rgb(0, 0, 0);"> String name;  
    </span><span style="color: rgb(0, 0, 255);">private</span><span style="color: rgb(0, 0, 0);"> String primaryKey;  
    </span><span style="color: rgb(0, 0, 255);">private</span> String secondaryKey = <span style="color: rgb(0, 0, 255);">null</span><span style="color: rgb(0, 0, 0);">;  
    </span><span style="color: rgb(0, 0, 255);">private</span> Map<span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">String,</span> <span class="attribute" style="color: rgb(0, 128, 128);">Class</span>&lt;?&gt;</span>&gt; columnTypeMap;    <span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);"> config.containerFactory.getAttrsMap();  </span>
<span class="indent">  </span>
    <span style="color: rgb(0, 0, 255);">private</span> Class<span class="pi" style="color: rgb(153, 153, 153); font-weight: bold;">&lt;? extends Model&lt;?&gt;</span>&gt; modelClass;</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">columnTypeMap是关键字段，暂且记下来。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">下面我们还是回到TableBuilder里的doBuild(table, conn, config);方法。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这个才是DB映射的关键，我其实直接讲这一个类就可以的......这个方法代码实在太多了，我贴部分代码做讲解吧。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">那么第六步：doBuild详解。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这块有点类，我直接在代码里写注释吧：</p><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">@SuppressWarnings(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">unchecked</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">)  
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">private</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">static</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> doBuild(Table table, Connection conn, Config config) throws SQLException {  
  
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 初始化 Table 里的columnTypeMap字段。  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span style="color: rgb(0, 0, 0);"><span class="indent">  </span>table.setColumnTypeMap(config.containerFactory.getAttrsMap());  
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 取得主键，如果取不到的话，默认设置&quot;id&quot;。  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 记不记得最开始的两个同名不同参的方法 addMapping(...)，</span></span><span style="color: rgb(0, 128, 0);"></span>
<span style="color: rgb(0, 0, 0);">在这才体现出后续处理的不同。  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (table.getPrimaryKey() == <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">)  
<span class="indent">  </span><span class="indent">  </span>table.setPrimaryKey(config.dialect.getDefaultPrimaryKey());  
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 此处如果没有设置方言，则默认	Dialect dialect = new MysqlDialect(); Mysql的方言。  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> sql为&quot;select * from `&quot; + tableName + &quot;` where 1 = 2&quot;;  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>String sql =<span style="color: rgb(0, 0, 0);"> config.dialect.forTableBuilderDoBuild(table.getName());  
<span class="indent">  </span>Statement stm </span>=<span style="color: rgb(0, 0, 0);"> conn.createStatement();  
<span class="indent">  </span>ResultSet rs </span>=<span style="color: rgb(0, 0, 0);"> stm.executeQuery(sql);  
<span class="indent">  </span>   </span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);">取得个字段的信息  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>ResultSetMetaData rsmd =<span style="color: rgb(0, 0, 0);"> rs.getMetaData();  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> 匹配映射  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">for</span></span> (<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">int</span></span> i=<span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">1</span></span>; i&lt;=rsmd.getColumnCount(); i++<span style="color: rgb(0, 0, 0);">) {  
<span class="indent">  </span><span class="indent">  </span>String colName </span>=<span style="color: rgb(0, 0, 0);"> rsmd.getColumnName(i);  
<span class="indent">  </span><span class="indent">  </span>String colClassName </span>=<span style="color: rgb(0, 0, 0);"> rsmd.getColumnClassName(i);  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.String</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> varchar, char, enum, set, text, tinytext, mediumtext, longtext  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, String.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.Integer</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> int, integer, tinyint, smallint, mediumint  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, Integer.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.Long</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> bigint  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, Long.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> else if (&quot;java.util.Date&quot;.equals(colClassName)) {	   </span></span><span style="color: rgb(0, 128, 0);">
</span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> java.util.Data can not be returned  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> java.sql.Date, java.sql.Time, </span></span><span style="color: rgb(0, 128, 0);"></span>
java.sql.Timestamp all extends java.util.Data so getDate can <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span><span style="color: rgb(0, 0, 0);"> the three types data  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> result.addInfo(colName, java.util.Date.class);  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> }  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.sql.Date</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> date, year  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, java.sql.Date.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.Double</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> real, double  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, Double.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.Float</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> float  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, Float.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.lang.Boolean</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> bit  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, Boolean.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.sql.Time</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> time  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, java.sql.Time.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.sql.Timestamp</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> timestamp, datetime  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, java.sql.Timestamp.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">java.math.BigDecimal</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> decimal, numeric  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, java.math.BigDecimal.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">[B</span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span><span style="color: rgb(0, 0, 0);">.equals(colClassName)) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> binary, varbinary, tinyblob, blob, mediumblob, longblob  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> qjd project: print_info.content varbinary(61800);  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">byte</span></span>[].<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">int</span></span> type =<span style="color: rgb(0, 0, 0);"> rsmd.getColumnType(i);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (type ==<span style="color: rgb(0, 0, 0);"> Types.BLOB) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">byte</span></span>[].<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span> (type == Types.CLOB || type ==<span style="color: rgb(0, 0, 0);"> Types.NCLOB) {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, String.</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>table.setColumnType(colName, String.</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">);  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> core.TypeConverter  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> throw new RuntimeException</span></span><span style="color: rgb(0, 128, 0);"></span>
(<span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">You've got new type to mapping. Please add code in </span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span> + TableBuilder.<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">class</span></span><span style="color: rgb(0, 0, 0);">.getName()
 </span>+ <span style="color: rgb(128, 0, 0);"><span class="string" style="color: rgb(221, 17, 68);">&quot;</span></span><span class="string" style="color: rgb(221, 17, 68);"><span style="color: rgb(128, 0, 0);">. The ColumnClassName can't be mapped: </span><span style="color: rgb(128, 0, 0);">&quot;</span></span><span style="color: rgb(128, 0, 0);"></span> +<span style="color: rgb(0, 0, 0);"> colClassName);  
<span class="indent">  </span><span class="indent">  </span>}  
<span class="indent">  </span>}  
<span class="indent">  </span>  
<span class="indent">  </span>rs.close();  
<span class="indent">  </span>stm.close();  
}  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这里巧妙的运用了 where 1=2的无检索条件结果，通过ResultSetMetaData rsmd = rs.getMetaData(); 导出了DB模型，这招确实漂亮。之前我还冥思苦相，他是怎么做的呢，看着此处源码，茅塞顿开。</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">接着，把编辑好的Table实例，放到TableMapping的成员变量 Model&lt;?&gt;&gt;, Table&gt; modelToTableMap 里去，TableMapping是单例的。</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);">private</span> final Map<span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">Class&lt;?</span> <span class="attribute" style="color: rgb(0, 128, 128);">extends</span> <span class="attribute" style="color: rgb(0, 128, 128);">Model</span>&lt;?&gt;</span>&gt;, Table&gt; modelToTableMap=
<span style="color: rgb(0, 0, 255);">new</span> HashMap<span class="tag" style="color: rgb(0, 0, 128);">&lt;<span class="title">Class&lt;?</span> <span class="attribute" style="color: rgb(0, 128, 128);">extends</span> <span class="attribute" style="color: rgb(0, 128, 128);">Model</span>&lt;?&gt;</span>&gt;, Table&gt;();</pre><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">void</span></span><span style="color: rgb(0, 0, 0);"> putTable(Table table) {  
        modelToTableMap.put(table.getModelClass(), table);  
    }  </span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">这样，所有的映射关系就都存在TableMapping的modelToTableMap</p><pre class="prettyprint http" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span class="attribute" style="color: rgb(0, 128, 128);">tableMapping.putTable(table);</span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">再将modelToConfig都放入DbKit.modelToConfig里。</p><pre class="prettyprint undefined" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">DbKit.addModelToConfigMapping(table.getModelClass(), config);</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">第七步，使用</p><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">Model里的save方法举例：</p><pre class="prettyprint java" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 128, 0);"><span class="javadoc" style="color: rgb(153, 153, 136); font-style: italic;">/*</span></span><span class="javadoc" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);">* 
 * Save model. 
 </span><span style="color: rgb(0, 128, 0);">*/</span></span><span style="color: rgb(0, 128, 0);"></span>  
<span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">public</span></span><span style="color: rgb(0, 0, 0);"> <span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">boolean</span> save() {  
<span class="indent">  </span>Config config </span>=<span style="color: rgb(0, 0, 0);"> getConfig();  
<span class="indent">  </span>Table table </span>=<span style="color: rgb(0, 0, 0);"> getTable();  
<span class="indent">  </span>  
<span class="indent">  </span>StringBuilder sql </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> StringBuilder();  
<span class="indent">  </span>List</span><object> paras = <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span> ArrayList</object><object><span style="color: rgb(0, 0, 0);">();  
<span class="indent">  </span>config.dialect.forModelSave(table, attrs, sql, paras);  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> if (paras.size() == 0)   return false;   </span></span><span style="color: rgb(0, 128, 0);">
</span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> The sql &quot;insert into tableName() values()&quot; works fine, so delete this line  </span></span><span style="color: rgb(0, 128, 0);">
<span class="indent">  </span>  
<span class="indent">  </span></span><span style="color: rgb(0, 128, 0);"><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;">//</span></span><span class="comment" style="color: rgb(153, 153, 136); font-style: italic;"><span style="color: rgb(0, 128, 0);"> --------  </span></span><span style="color: rgb(0, 128, 0);"></span>
<span class="indent">  </span>Connection conn = <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span>PreparedStatement pst </span>= <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">null</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">int</span></span> result = <span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">0</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">try</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span>conn </span>=<span style="color: rgb(0, 0, 0);"> config.getConnection();  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">if</span></span><span style="color: rgb(0, 0, 0);"> (config.dialect.isOracle())  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>pst </span>=<span style="color: rgb(0, 0, 0);"> conn.prepareStatement(sql.toString(), 
</span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> String[]{table.getPrimaryKey()});  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">else</span></span><span style="color: rgb(0, 0, 0);">  
<span class="indent">  </span><span class="indent">  </span><span class="indent">  </span>pst </span>=<span style="color: rgb(0, 0, 0);"> conn.prepareStatement(sql.toString(), 
Statement.RETURN_GENERATED_KEYS);  
<span class="indent">  </span><span class="indent">  </span>  
<span class="indent">  </span><span class="indent">  </span>config.dialect.fillStatement(pst, paras);  
<span class="indent">  </span><span class="indent">  </span>result </span>=<span style="color: rgb(0, 0, 0);"> pst.executeUpdate();  
<span class="indent">  </span><span class="indent">  </span>getGeneratedKey(pst, table);  
<span class="indent">  </span><span class="indent">  </span>getModifyFlag().clear();  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span> result &gt;= <span style="color: rgb(128, 0, 128);"><span class="number" style="color: rgb(0, 153, 153);">1</span></span><span style="color: rgb(0, 0, 0);">;  
<span class="indent">  </span>} </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">catch</span></span><span style="color: rgb(0, 0, 0);"> (Exception e) {  
<span class="indent">  </span><span class="indent">  </span></span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">throw</span></span> <span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">new</span></span><span style="color: rgb(0, 0, 0);"> ActiveRecordException(e);  
<span class="indent">  </span>} </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">finally</span></span><span style="color: rgb(0, 0, 0);"> {  
<span class="indent">  </span><span class="indent">  </span>config.close(pst, conn);  
<span class="indent">  </span>}  
}  </span></object></pre><pre class="prettyprint undefined" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">Config config = getConfig();</pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">上面这行就是调用DbKit的方法,取得DB配置。</p><pre class="prettyprint xml" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">static</span> Config getConfig(Class<span class="pi" style="color: rgb(153, 153, 153); font-weight: bold;">&lt;? extends Model&gt;<span style="color: rgb(0, 0, 0);"> modelClass) {  
    </span><span style="color: rgb(0, 0, 255);">return</span> modelToConfig.<span style="color: rgb(0, 0, 255);">get</span><span style="color: rgb(0, 0, 0);">(modelClass);  
}  </span></span><span style="color: rgb(0, 0, 0);"></span></pre><p style="margin: 0px 0px 0.75em; line-height: 1.7em; text-indent: 1em;">下面这段代码是去单例的TableMapping里取得表的具体信息。</p><pre class="prettyprint undefined" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);">Table table = getTable();</pre><pre class="prettyprint cs" style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 12px; line-height: 1.5em; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(246, 246, 246);"><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">private</span></span><span style="color: rgb(0, 0, 0);"> Table getTable() {  
    </span><span style="color: rgb(0, 0, 255);"><span class="keyword" style="color: rgb(51, 51, 51); font-weight: bold;">return</span></span><span style="color: rgb(0, 0, 0);"> TableMapping.me().getTable(getClass());  
}  </span></pre></div></div><div class="article_social" style="margin-bottom: 10px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-size: 14px; line-height: 21px;"><div class="article_like" style="width: 70px; height: 70px; margin: 0px auto;"></div></div></p>
      </ul>
    
    </div>
  </article>
  <aside>
    <div class="rnav">
       <li class="rnav1"><a href="./wdfx.html">我的分享</a></li>
       <li class="rnav2"><a href="./sxxj.html">随心小记</a></li>
    </div>
    <div class="ph_news">
      <h2>
        <p>最新文章</p>
      </h2>
      <ul class="ph_n">
      <li>
				<span class="num1">1</span>
			<a href="./article22.html">代码生成器[五一假期成果]</a></li>
      <li>
				<span class="num2">2</span>
			<a href="./article21.html">那些鸡汤[持续收集]</a></li>
      <li>
				<span>3</span>
			<a href="./article20.html">云峰，你的2015的那些错过</a></li>
      <li>
				<span>4</span>
			<a href="./article19.html">读懂正则表达式就这么简单[转载]</a></li>
      <li>
				<span>5</span>
			<a href="./article18.html">Java文件操作大全[转载]</a></li>
      </ul>
    </div>
    <div class="copyright">
      <ul>
         <p> modification by <a href="mailto:capfyun@foxmail.com">capfyun</a></p>
        <p>./</p>
        </p>
      </ul>
    </div>
  </aside>
  <div class="clear"></div>
  <!-- 清除浮动 --> 
</div>
</body>
</html>
